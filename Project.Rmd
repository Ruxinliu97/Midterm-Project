---
title: "Toronto Transit Commission (TTC) Streetcar Delay"
author: "Ruxin Liu"
date: "11/5/2020"
output: pdf_document
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, fig.height = 3, fig.width = 7, fig.align = "center")
```

```{r, echo = FALSE, message = FALSE}
delay_14 <- read.csv("ttc-streetcar-delay-data-2014.csv", header = TRUE)
delay_15 <- read.csv("ttc-streetcar-delay-data-2015.csv", header = TRUE)
delay_16 <- read.csv("ttc-streetcar-delay-data-2016.csv", header = TRUE)
delay_17 <- read.csv("ttc-streetcar-delay-data-2017.csv", header = TRUE)
delay_18 <- read.csv("ttc-streetcar-delay-data-2018.csv", header = TRUE)
delay_19 <- read.csv("ttc-streetcar-delay-data-2019.csv", header = TRUE)
delay_20 <- read.csv("ttc-streetcar-delay-data-2020.csv", header = TRUE)

colnames(delay_20)[7] <- "Min.Delay"  
colnames(delay_20)[8] <- "Min.Gap"  

delay <- rbind(delay_14, delay_15, delay_16, delay_17, delay_18, delay_19, delay_20)

library(lubridate)
library(tidyverse)
library(dplyr)
delay$Report.Date <- ymd(delay$Report.Date)
delay$year <- year(delay$Report.Date)
delay$month <- month(delay$Report.Date)

weather <- read.csv("Weather.csv")
weather <- weather[-c(13 : 84), ]
colnames(weather)[1] <- "month"
delay_final <- left_join(delay, weather, by = "month")

delay_final <- delay_final[-82703, ]

for(i in 1 : nrow(delay_final)) {
  if(delay_final$month[i] == 1) {
    delay_final$month[i] <- "Jan"
  }
  if(delay_final$month[i] == 2) {
    delay_final$month[i] <- "Feb"
  }
  if(delay_final$month[i] == 3) {
    delay_final$month[i] <- "Mar"
  }
  if(delay_final$month[i] == 4) {
    delay_final$month[i] <- "Apr"
  }
  if(delay_final$month[i] == 5) {
    delay_final$month[i] <- "May"
  }
  if(delay_final$month[i] == 6) {
    delay_final$month[i] <- "Jun"
  }
  if(delay_final$month[i] == 7) {
    delay_final$month[i] <- "Jul"
  }
  if(delay_final$month[i] == 8) {
    delay_final$month[i] <- "Aug"
  }
  if(delay_final$month[i] == 9) {
    delay_final$month[i] <- "Sep"
  }
  if(delay_final$month[i] == 10) {
    delay_final$month[i] <- "Oct"
  }
  if(delay_final$month[i] == 11) {
    delay_final$month[i] <- "Nov"
  }
  if(delay_final$month[i] == 12) {
    delay_final$month[i] <- "Dec"
  }
}

delay_final$weekend <- ifelse(delay_final$Day == "Sunday" | delay_final$Day == "Saturday", 1, 0)

route_ttc <- c(501, 503, 504, 505, 506, 508, 509, 510, 511, 512)
delay_final <- delay_final %>% 
  filter(Route %in% route_ttc)
```

# Abstract


# Introduction


  When walking in the street in Toronto, Canada, it is very common to see the red
  and white streetcars driving around. These streetcars are operated by the Toronto
  Transit Commission (TTC) and there are in total 10 different streetcar routes, 
  which bring large convenience and efficiency to the transportation system in the
  city of Toronto (Wikipedia 2020). However, as many other public traffic systems 
  do, TTC streetcars also have frequent delays. The City of Toronto's Open Data 
  Portal has collected TTC streetcar delay information from the year 2014 to the 
  year 2020 and the data sets include information, such as the incident, the date,
  the route and the length of the delay (Open Data Portal 2020). 
  
  
  In this study, the major question is that what factors could potentially impact
  the delayed time. In order to answer this, a multilevel negative binomial regression 
  is fitted to the data to explore the relationships between the delayed incident, 
  the delayed day, and the length of the delay, while accounting for different streetcar
  routes. 
  
  
  
# Method

### Data Content

  The data was downloaded from The City of Toronto's Open Data Portal and was cleaned
and processed in R (all the detailed codes are in the file: Supplementary R code.Rmd).
The data was subsetted on the 10 routes that are part of the Toronto streetcar system,
which are route number 501, 503, 504, 505, 506, 508, 509, 510, 511 and 512. Table.1 
below shows the major information collected in this data, where Min.Delay is the 
length of the delay in minutes to the schedule for the following streetcar.


```{r, warning = FALSE, message = FALSE, echo = FALSE}
library(kableExtra)
kable(head(delay_final[c(1, 500, 1000, 9900, 13000), 1 : 7]), 
      caption = "Table.1: Data Content")
```


### Variable Selection

  In order to explore the potential factors that can impact the delayed time, 
  exploratory data analysis (EDA) is performed. From Fig.1, it is very clear that
  the distribution of the delayed time related to different delay-causing incidents
  varies a lot, especially when there is a diversion happening, the delayed time 
  is much longer compared to the other incidents. Also, lots of the outliers are 
  observed from the plot.
  

```{r, warning = FALSE, message = FALSE, echo = FALSE}
ggplot(data = delay_final, aes(x = Incident, y = Min.Delay)) + 
  geom_boxplot() +
  coord_flip() +
  ylim(0, 200) +
  xlab("Delayed Incident") +
  ylab("Delay in Minutes") +
  ggtitle("Fig.1 Relation Between Incident Type & Delay Length") +
  theme(plot.title = element_text(hjust = 0.5))
```


  From Fig.2, although for all 7 days in the week, there are many outliers and 
  the 3rd quartiles are relatively at the same level, the 1st quartiles of Saturday
  and Sunday are higher compared to the other days. Therefore, an variable "weekend" 
  is created to indicate whether the day is a weekend or not to capture the difference
  in streetcar delay time between weekdays and weekends.
  
  
```{r, warning = FALSE, message = FALSE, echo = FALSE}
ggplot(data = delay_final, aes(x = Day, y = Min.Delay)) + 
  geom_boxplot() +
  ylim(0, 50) +
  xlab("Day") +
  ylab("Delay in Minutes") +
  ggtitle("Fig.2 Relation Between Incident Type & Delay Day") +
  theme(plot.title = element_text(hjust = 0.5))
```


### Model Selection & Validation 

  The response variable in this project is the length of delay in minutes (Min.Delay), 
  which is a continuous and numerical variable. However, the data does not have a 
  normal distribution even after transformations, and since the delayed time is 
  recorded to the nearest minute, the variable Min.Delay performs like a discrete 
  variable. Therefore, the response variable is considered as the count data (the
  number of delayed minutes) and the negative binomial regression is performed 
  instead of the liner model. 
  
  
  

```{r}
model_poisson <- glm(Min.Delay ~ Incident + weekend, family = "poisson", data = delay_final)
plot(fitted(model_poisson),resid(model_poisson),pch=20)
# indicate overdispersion
curve(sqrt(x),add=T)
```


```{r}
library(MASS)
model_nb <- glm.nb((Min.Delay ) ~ Incident + weekend, data = delay_final)
```

```{r}
summary(model_nb)
```

```{r}
plot(fitted(model_nb),resid(model_nb),pch=20)
# indicate overdispersion
curve(sqrt(x),add=T)
```






```{r}
library(lme4)
nb_route <- glmer.nb(Min.Delay ~ Incident + weekend + (1 | Route), data = delay_final)
```

```{r}
summary(nb_route)
```

```{r}
plot(fitted(nb_route),resid(nb_route),pch=20)
# indicate overdispersion
curve(sqrt(x),add=T)
```

```{r}
# install.packages("countreg", repos="http://R-Forge.R-project.org")
library(countreg)
rootogram(model_nb)
```





# Result




# Discussion


### Future Directions

# Appendix

### EDA 

```{r, warning = FALSE, message = FALSE, echo = FALSE, fig.cap = "The distribution of the delayed time (Min.Delay) is not very normally distributed after log transformation, therefore suggesting that a linear model is not appropriate for this data."}
hist(log(delay_final$Min.Delay + 1), main = "Distribution of The Delayed Time (min)",
     xlab = "log(Min.Delay + 1)")
```



```{r, message = FALSE, warning = FALSE, echo = FALSE}
# Difference between each delayed incident
incident <- delay %>% 
  group_by(Incident) %>% 
  summarize(`mean(min)` = mean(Min.Delay), 
            `mean(hr)` = mean(Min.Delay) / 60,
            `max(min)` = max(Min.Delay),
            `max(hr)` = max(Min.Delay) / 60)
kable(incident, "simple", digits = 2, caption = "Table.1 The average delayed length
      and the maximum delayed length both vary a lot among different incidents,
      which suggests that incident is a important variable to consider. ")
```


### Model Fitting



```{r}

# Varying intercept and slopes
#model_multi <- lmer(Min.Delay ~ Incident + Rain + (1 + Incident | month), data = delay_final)
```

```{r}
#plot(model_multi)
```



```{r}
# Display the average coefficients 
#fixef(model_multi)
```

```{r}
# Display the group-level errors for the intercepts and slopes
#ranef(model_multi)
```




```{r}
library(lme4)
#route <- lmer(log(Min.Delay + 1) ~Incident + weekend + (1 | Route), data = delay_final)
#plot(route)
```
```{r}
#qqnorm(resid(route))
#qqline(resid(route))
```



```{r}
mean(delay_final$Min.Delay, na.rm = TRUE)
delay_final$min_15 <- ifelse(delay_final$Min.Delay <= 15, 1, 0)
#time_15 <- glmer(factor(min_15) ~ Day + (1 | Incident),  family = binomial("logit"), data = delay_final)
```


```{r}
#logistic <- glmer(min_15 ~ Incident+Day+(1|Route),data=delay_final,family=binomial(link="logit"))
```

```{r}
#glm <-  glm(min_15 ~ Incident+weekend,data=delay_final,family=binomial(link="logit"))
```

```{r}
#summary(glm)
library(arm)
#binnedplot(fitted(glm),resid(glm))
```




```{r}
library(arm)
#binnedplot(fitted(logistic),resid(logistic))
```



## Model Checking

### Checking Assumption -- Linearity



```{r}
test2 <- delay_final[delay_final$Min.Delay<100,]
test2 <- test2 %>% 
  filter(Min.Delay!=0)
hist(log(test2$Min.Delay ))
model<- lm(log(Min.Delay) ~ Incident, data=test2)
summary(model)
plot(model, which = 2)
plot(model, which = 1) 
```



```{r, warning = FALSE, message = FALSE, eval = FALSE}
ggplot(delay[delay$Min.Delay < 60,]) +
  geom_density(alpha = 0.3) +
  aes(x = Min.Delay, color = factor(month)) + 
  facet_wrap(~ factor(month)) + 
  geom_rug() +
  xlab("Delay in Minutes") +
  theme(legend.position="none") +
  ggtitle("Fig.2 Distribution of the delay length among different months") +
  geom_vline(xintercept = mean(delay$Min.Delay), color = "red",lty = 2) +
  theme(plot.title = element_text(hjust = 0.5))
```

# Bibliography

## Online Resources:

1. Wikipedia. (2020). *Toronto streetcar system* [online]. Available from: https://en.wikipedia.org/wiki/Toronto_streetcar_system#Route_numbers [accessed 29 November 2020]

2. Open Data Portal. (2020). *TTC Streetcar Delay Data* [online]. Available from: https://open.toronto.ca/dataset/ttc-streetcar-delay-data/ [accessed 5 November 2020]



## R package:

1. Garrett Grolemund, Hadley Wickham (2011). Dates and Times Made Easy with lubridate. Journal of Statistical
  Software, 40(3), 1-25. URL http://www.jstatsoft.org/v40/i03/. 
  
2. Wickham et al., (2019). Welcome to the tidyverse. Journal of Open Source Software, 4(43), 1686,
  https://doi.org/10.21105/joss.01686

3. Hadley Wickham, Romain François, Lionel Henry and Kirill Müller (2020). dplyr: A Grammar of Data
  Manipulation. R package version 1.0.2. https://CRAN.R-project.org/package=dplyr
  
4. Douglas Bates, Martin Maechler, Ben Bolker, Steve Walker (2015). Fitting Linear Mixed-Effects Models Using
  lme4. Journal of Statistical Software, 67(1), 1-48. doi:10.18637/jss.v067.i01.
  
5. Hao Zhu (2019). kableExtra: Construct Complex Table with 'kable' and
  Pipe Syntax. R package version 1.1.0.
  https://CRAN.R-project.org/package=kableExtra
  
6. Venables, W. N. & Ripley, B. D. (2002) Modern Applied Statistics with S. Fourth Edition. Springer,
  New York. ISBN 0-387-95457-0

  







